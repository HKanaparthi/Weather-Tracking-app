<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            height: 100%;
            color: #333;
            background-color: #b5cce1; /* Light blue background */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header and Navigation */
        header {
            margin-bottom: 20px;
        }

        .logo {
            font-weight: bold;
            font-size: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        nav ul {
            display: flex;
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        nav li {
            margin-right: 20px;
        }

        nav a {
            color: #fff;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        nav a.active {
            background-color: rgba(255, 255, 255, 0.3);
            font-weight: bold;
        }

        /* Main Content */
        main {
            padding-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #fff;
            text-align: center;
            position: relative;
        }

        h1::after {
            content: '';
            display: block;
            width: 180px;
            height: 3px;
            background-color: #ffa726; /* Orange underline */
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .section-description {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Current Weather Summary */
        .current-weather-summary {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .current-weather-details {
            flex: 1;
            min-width: 200px;
        }

        .current-location {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .current-condition {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .current-condition-icon {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }

        .current-condition-text {
            font-size: 1.2rem;
            color: #333;
        }

        .current-temp {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .current-temp-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .current-temp-detail {
            display: flex;
            align-items: center;
        }

        .current-temp-detail-icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }

        .current-temp-detail-text {
            font-size: 0.9rem;
            color: #333;
        }

        /* Location Search */
        .location-search {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .location-search input {
            padding: 10px;
            border-radius: 4px 0 0 4px;
            border: none;
            width: 300px;
            font-size: 1rem;
        }

        .location-search button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-size: 1rem;
        }

        .location-search button:hover {
            background-color: #2980b9;
        }

        /* Impact Filter */
        .impact-filter {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
        }

        .impact-filter h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }

        .impact-categories {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .impact-category {
            background-color: rgba(255, 255, 255, 0.5);
            border: 2px solid transparent;
            border-radius: 30px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .impact-category:hover {
            background-color: rgba(255, 255, 255, 0.7);
        }

        .impact-category.active {
            background-color: rgba(255, 255, 255, 0.8);
            border-color: #3498db;
            font-weight: bold;
        }

        .impact-category-icon {
            width: 20px;
            height: 20px;
        }

        /* Impact Cards */
        .impact-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .impact-card {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .impact-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .impact-card.highlight {
            box-shadow: 0 0 0 3px #3498db;
        }

        .impact-card-header {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .impact-card-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .impact-card-icon {
            width: 24px;
            height: 24px;
        }

        .impact-card-rating {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .impact-card-rating-text {
            font-weight: bold;
        }

        .favorable {
            color: #27ae60;
        }

        .moderate {
            color: #f39c12;
        }

        .unfavorable {
            color: #e74c3c;
        }

        .impact-card-body {
            padding: 15px;
        }

        .impact-card-description {
            margin-bottom: 15px;
            color: #333;
        }

        .impact-card-factors {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
        }

        .impact-card-factor {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .impact-card-factor:last-child {
            margin-bottom: 0;
        }

        .impact-card-factor-name {
            color: #555;
        }

        .impact-card-factor-value {
            font-weight: bold;
            color: #333;
        }

        /* Loading Indicator */
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-indicator.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* No Results */
        .no-results {
            display: none;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .no-results h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }

        .no-results p {
            color: #555;
            margin-bottom: 20px;
        }

        /* Footer */
        footer {
            margin-top: 40px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        /* Detailed Impact Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-rating {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .modal-description {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-factors {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .modal-factor {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .modal-factor:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .modal-recommendations {
            margin-top: 20px;
        }

        .modal-recommendations h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .recommendation-item {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .recommendation-icon {
            color: #3498db;
            flex-shrink: 0;
            margin-top: 3px;
        }

        /* Weather Alert Banner */
        .weather-alert {
            background-color: #f39c12;
            color: white;
            padding: 10px 20px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .weather-alert.active {
            display: block;
        }

        .weather-alert i {
            margin-right: 10px;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .current-weather-summary {
                flex-direction: column;
            }

            .current-weather-details {
                margin-bottom: 20px;
            }

            .impact-cards {
                grid-template-columns: 1fr;
            }

            .location-search input {
                width: 200px;
            }

            nav ul {
                flex-wrap: wrap;
            }

            nav li {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <nav>
            <div class="logo">Weather Impact App</div>
            <ul>
                <li><a href="/weather-impact" class="active">Weather Impact</a></li>
                <li><a href="/dashboard">Current Weather</a></li>
                <li><a href="/historical-comparison">History</a></li>
                <li><a href="/profile">Your Profile</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1>Weather Impact Assessment</h1>
        <p class="section-description">
            See how current and forecasted weather conditions might affect various activities and plan accordingly.
        </p>

        <!-- Location Search -->
            <div class="location-search">
                <form action="/weather-impact" method="get">
                    <input type="text" name="city" value="Charlotte">
                    <button type="submit">Search</button>
                </form>


        <!-- Weather Alert Banner -->
        <div class="weather-alert" id="weather-alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="alert-text">Heavy rain expected in the next 12 hours. Plan indoor activities.</span>
        </div>

        <!-- Loading Indicator -->
        <div class="loading-indicator" id="loading-indicator">
            <div class="spinner"></div>
            <p>Loading weather data...</p>
        </div>

        <!-- Current Weather Summary -->
        <div class="current-weather-summary" id="current-weather-summary" style="display: none;">
            <div class="current-weather-details">
                <div class="current-location" id="current-location">Loading...</div>
                <div class="current-condition">
                    <img src="" alt="" id="current-condition-icon" class="current-condition-icon">
                    <div class="current-condition-text" id="current-condition-text">Loading...</div>
                </div>
                <div class="current-temp" id="current-temp">--°C</div>
                <div class="current-temp-details">
                    <div class="current-temp-detail">
                        <i class="fas fa-tint current-temp-detail-icon"></i>
                        <div class="current-temp-detail-text" id="current-humidity">Humidity: --</div>
                    </div>
                    <div class="current-temp-detail">
                        <i class="fas fa-wind current-temp-detail-icon"></i>
                        <div class="current-temp-detail-text" id="current-wind">Wind: --</div>
                    </div>
                    <div class="current-temp-detail">
                        <i class="fas fa-eye current-temp-detail-icon"></i>
                        <div class="current-temp-detail-text" id="current-visibility">Visibility: --</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Impact Filter -->
        <div class="impact-filter" id="impact-filter" style="display: none;">
            <h2>Select Activity Category</h2>
            <div class="impact-categories">
                <div class="impact-category active" data-category="all">
                    <i class="fas fa-globe"></i>
                    All
                </div>
                <div class="impact-category" data-category="outdoor">
                    <i class="fas fa-hiking"></i>
                    Outdoor Sports
                </div>
                <div class="impact-category" data-category="agriculture">
                    <i class="fas fa-seedling"></i>
                    Agriculture
                </div>
                <div class="impact-category" data-category="travel">
                    <i class="fas fa-plane"></i>
                    Travel
                </div>
                <div class="impact-category" data-category="health">
                    <i class="fas fa-heartbeat"></i>
                    Health
                </div>
                <div class="impact-category" data-category="construction">
                    <i class="fas fa-hard-hat"></i>
                    Construction
                </div>
            </div>
        </div>

        <!-- Impact Cards -->
        <div class="impact-cards" id="impact-cards" style="display: none;"></div>

        <!-- No Results -->
        <div class="no-results" id="no-results">
            <h3>No matching activities found</h3>
            <p>Try selecting a different category or check back later for updated recommendations.</p>
        </div>
    </main>

    <footer>
        <p>&copy; {{ .currentYear }} Weather Impact App. All rights reserved.</p>
    </footer>

    <!-- Detailed Impact Modal -->
    <div class="modal" id="impact-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Activity Impact</div>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be dynamically added here -->
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        console.log('DOM has loaded!');

        const locationInput = document.getElementById('location-input');
        const searchButton = document.getElementById('search-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const currentWeatherSummary = document.getElementById('current-weather-summary');
        const impactFilter = document.getElementById('impact-filter');
        const impactCards = document.getElementById('impact-cards');
        const noResults = document.getElementById('no-results');
        const weatherAlert = document.getElementById('weather-alert');
        const alertText = document.getElementById('alert-text');
        const modal = document.getElementById('impact-modal');
        const modalClose = document.getElementById('modal-close');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        // Weather Data
        let currentWeather = null;

        // Initialize
        init();

        function init() {
            // Set up event listeners
            setupEventListeners();

            // Load weather data for default location
            loadWeatherData(locationInput.value);
        }

        function setupEventListeners() {
            // Search button
            searchButton.addEventListener('click', function() {
                loadWeatherData(locationInput.value);
            });

            // Enter key in search input
            locationInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadWeatherData(locationInput.value);
                }
            });

            // Category filtering
            const categories = document.querySelectorAll('.impact-category');
            categories.forEach(category => {
                category.addEventListener('click', function() {
                    // Remove active class from all categories
                    categories.forEach(cat => cat.classList.remove('active'));

                    // Add active class to clicked category
                    this.classList.add('active');

                    // Filter cards
                    filterImpactCards(this.getAttribute('data-category'));
                });
            });

            // Modal close button
            modalClose.addEventListener('click', function() {
                modal.classList.remove('active');
            });

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        function loadWeatherData(location) {
            // Show loading indicator
            loadingIndicator.classList.add('active');
            currentWeatherSummary.style.display = 'none';
            impactFilter.style.display = 'none';
            impactCards.style.display = 'none';
            noResults.style.display = 'none';

            // In a real app, you'd make an API call to OpenWeatherMap
            // For this demo, we'll simulate the API call with setTimeout
            setTimeout(() => {
                fetchWeatherData(location)
                    .then(data => {
                        currentWeather = data;
                        updateWeatherDisplay(data);
                        generateImpactAssessments(data);

                        // Hide loading indicator
                        loadingIndicator.classList.remove('active');
                        currentWeatherSummary.style.display = 'flex';
                        impactFilter.style.display = 'block';
                        impactCards.style.display = 'grid';

                        // Check for weather alerts
                        checkWeatherAlerts(data);
                    })
                    .catch(error => {
                        console.error('Error fetching weather data:', error);
                        loadingIndicator.classList.remove('active');
                        alert('Error fetching weather data. Please try a different location or try again later.');
                    });
            }, 1000);
        }

        function fetchWeatherData(location) {
            // In a real app, this would be an actual API call
            // For demo purposes, we'll simulate a response
            return new Promise((resolve) => {
                // Create a fake weather data object
                // In reality, you would get this from the OpenWeatherMap API
                const data = {
                    location: location,
                    current: {
                        temp: Math.floor(Math.random() * 30) + 5, // Random temp between 5-35°C
                        weather: {
                            main: getRandomWeather(),
                            description: getRandomWeatherDescription(),
                            icon: getRandomWeatherIcon()
                        },
                        humidity: Math.floor(Math.random() * 50) + 30, // Random humidity 30-80%
                        wind_speed: Math.floor(Math.random() * 20) + 1, // Random wind 1-20 km/h
                        visibility: Math.floor(Math.random() * 5) + 5, // Random visibility 5-10 km
                        uvi: Math.floor(Math.random() * 10) + 1, // Random UV index 1-10
                    }
                };

                resolve(data);
            });
        }

        function getRandomWeather() {
            const conditions = ['Clear', 'Clouds', 'Rain', 'Drizzle', 'Thunderstorm', 'Snow', 'Mist'];
            return conditions[Math.floor(Math.random() * conditions.length)];
        }

        function getRandomWeatherDescription() {
            const descriptions = {
                'Clear': 'clear sky',
                'Clouds': 'partly cloudy',
                'Rain': 'light rain',
                'Drizzle': 'light drizzle',
                'Thunderstorm': 'thunderstorm',
                'Snow': 'light snow',
                'Mist': 'mist'
            };

            const weather = getRandomWeather();
            return descriptions[weather];
        }

        function getRandomWeatherIcon() {
            const icons = ['01d', '02d', '03d', '04d', '09d', '10d', '11d', '13d', '50d'];
            return icons[Math.floor(Math.random() * icons.length)];
        }

        function updateWeatherDisplay(data) {
            document.getElementById('current-location').textContent = data.location;
            document.getElementById('current-condition-text').textContent = data.current.weather.description;
            document.getElementById('current-condition-icon').src = `https://openweathermap.org/img/wn/${data.current.weather.icon}@2x.png`;
            document.getElementById('current-condition-icon').alt = data.current.weather.description;
            document.getElementById('current-temp').textContent = `${data.current.temp}°C`;
            document.getElementById('current-humidity').textContent = `Humidity: ${data.current.humidity}%`;
            document.getElementById('current-wind').textContent = `Wind: ${data.current.wind_speed} km/h`;
            document.getElementById('current-visibility').textContent = `Visibility: ${data.current.visibility} km`;
        }

        function checkWeatherAlerts(data) {
            // In a real app, you would check the weather data for alerts
            // For this demo, we'll randomly show an alert sometimes
            if (Math.random() > 0.7) {
                const alerts = [
                    "Heavy rain expected in the next 12 hours. Plan indoor activities.",
                    "High winds forecasted. Secure loose objects outdoors.",
                    "Thunderstorms possible this afternoon. Stay alert.",
                    "Heat advisory in effect. Stay hydrated and seek shade.",
                    "Air quality alert issued. Limit outdoor activities.",
                    "Freezing temperatures expected tonight. Protect plants and pipes."
                ];

                alertText.textContent = alerts[Math.floor(Math.random() * alerts.length)];
                weatherAlert.classList.add('active');
            } else {
                weatherAlert.classList.remove('active');
            }
        }

        function generateImpactAssessments(data) {
            // Clear existing cards
            impactCards.innerHTML = '';

            // Generate impact cards based on current weather
            const activities = getActivitiesData(data);

            if (activities.length === 0) {
                noResults.style.display = 'block';
                return;
            }

            activities.forEach(activity => {
                const card = createImpactCard(activity);
                impactCards.appendChild(card);

                // Add click event to show modal
                card.addEventListener('click', function() {
                    showDetailedImpact(activity);
                });
            });
        }

        function getActivitiesData(weather) {
            // In a real application, this would use algorithms to determine
            // how current weather affects different activities
            // For this demo, we'll create sample data based on weather

            const temp = weather.current.temp;
            const weatherCondition = weather.current.weather.main;
            const humidity = weather.current.humidity;
            const windSpeed = weather.current.wind_speed;
            const visibility = weather.current.visibility;
            const uvi = weather.current.uvi || 5;

            // Generate activities with impact ratings
            const activities = [];

            // Outdoor Sports
            activities.push({
                title: "Running",
                category: "outdoor",
                icon: "fa-running",
                rating: getRatingForRunning(temp, weatherCondition, humidity, windSpeed),
                description: getDescriptionForRunning(temp, weatherCondition, humidity, windSpeed),
                factors: [
                    { name: "Temperature", value: `${temp}°C`, rating: getRatingForTemp(temp, "running") },
                    { name: "Humidity", value: `${humidity}%`, rating: getRatingForHumidity(humidity) },
                    { name: "Wind", value: `${windSpeed} km/h`, rating: getRatingForWind(windSpeed) },
                    { name: "UV Index", value: uvi.toString(), rating: getRatingForUV(uvi) }
                ],
                recommendations: getRecommendationsForRunning(temp, weatherCondition, humidity, windSpeed, uvi)
            });

            activities.push({
                title: "Cycling",
                category: "outdoor",
                icon: "fa-biking",
                rating: getRatingForCycling(temp, weatherCondition, windSpeed, visibility),
                description: getDescriptionForCycling(temp, weatherCondition, windSpeed, visibility),
                factors: [
                    { name: "Temperature", value: `${temp}°C`, rating: getRatingForTemp(temp, "cycling") },
                    { name: "Wind", value: `${windSpeed} km/h`, rating: getRatingForWind(windSpeed, "cycling") },
                    { name: "Precipitation", value: getPrecipitationValue(weatherCondition), rating: getRatingForPrecipitation(weatherCondition) },
                    { name: "Road Conditions", value: getRoadConditions(weatherCondition), rating: getRatingForRoadConditions(weatherCondition) }
                ],
                recommendations: getRecommendationsForCycling(temp, weatherCondition, windSpeed, uvi)
            });

            // Add more activities for different categories
            // Travel, Health, Construction, etc.

            return activities;
        }

        function createImpactCard(activity) {
            const card = document.createElement('div');
            card.className = 'impact-card';
            card.setAttribute('data-category', activity.category);

            const ratingClass = activity.rating.toLowerCase(); // favorable, moderate, or unfavorable

            card.innerHTML = `
            <div class="impact-card-header">
                <div class="impact-card-title">
                    <i class="fas ${activity.icon} impact-card-icon"></i>
                    ${activity.title}
                </div>
                <div class="impact-card-rating">
                    <i class="fas fa-circle ${ratingClass}"></i>
                    <span class="impact-card-rating-text ${ratingClass}">${activity.rating}</span>
                </div>
            </div>
            <div class="impact-card-body">
                <div class="impact-card-description">
                    ${activity.description}
                </div>
                <div class="impact-card-factors">
                    ${activity.factors.map(factor => `
                        <div class="impact-card-factor">
                            <span class="impact-card-factor-name">${factor.name}</span>
                            <span class="impact-card-factor-value ${factor.rating.toLowerCase()}">${factor.value} (${factor.rating})</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

            return card;
        }

        function filterImpactCards(category) {
            const cards = document.querySelectorAll('.impact-card');
            let visibleCount = 0;

            cards.forEach(card => {
                if (category === 'all' || card.getAttribute('data-category') === category) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show/hide no results message
            if (visibleCount === 0) {
                noResults.style.display = 'block';
            } else {
                noResults.style.display = 'none';
            }
        }

        function showDetailedImpact(activity) {
            modalTitle.textContent = activity.title;

            // Create modal content
            const ratingClass = activity.rating.toLowerCase();

            const modalContent = `
            <div class="modal-rating">
                <i class="fas fa-circle ${ratingClass}"></i>
                <span class="impact-card-rating-text ${ratingClass}">${activity.rating}</span>
            </div>
            <div class="modal-description">
                ${activity.description}
            </div>
            <div class="modal-factors">
                ${activity.factors.map(factor => `
                    <div class="modal-factor">
                        <span class="impact-card-factor-name">${factor.name}</span>
                        <span class="impact-card-factor-value ${factor.rating.toLowerCase()}">${factor.value} (${factor.rating})</span>
                    </div>
                `).join('')}
            </div>
            <div class="modal-recommendations">
                <h3>Recommendations</h3>
                ${activity.recommendations.map(rec => `
                    <div class="recommendation-item">
                        <span class="recommendation-icon"><i class="fas fa-check-circle"></i></span>
                        <span>${rec}</span>
                    </div>
                `).join('')}
            </div>
        `;

            modalBody.innerHTML = modalContent;
            modal.classList.add('active');
        }

        // Helper functions for weather impacts

        // Rating generators
        function getRatingForRunning(temp, weather, humidity, wind) {
            if (temp < 0 || temp > 30 || humidity > 85 || ['Rain', 'Thunderstorm', 'Snow'].includes(weather)) {
                return "Unfavorable";
            } else if ((temp < 10 || temp > 25) || (humidity > 70) || wind > 15 || weather === 'Drizzle') {
                return "Moderate";
            } else {
                return "Favorable";
            }
        }

        function getRatingForCycling(temp, weather, wind, visibility) {
            if (temp < -5 || temp > 35 || wind > 25 || visibility < 5 || ['Thunderstorm', 'Snow'].includes(weather)) {
                return "Unfavorable";
            } else if ((temp < 5 || temp > 30) || wind > 15 || weather === 'Rain') {
                return "Moderate";
            } else {
                return "Favorable";
            }
        }

        function getRatingForSwimming(temp, weather, uvi) {
            if (temp < 20 || ['Rain', 'Thunderstorm', 'Snow', 'Drizzle', 'Mist'].includes(weather)) {
                return "Unfavorable";
            } else if (temp < 25 || weather === 'Clouds' || uvi > 8) {
                return "Moderate";
            } else {
                return "Favorable";
            }
        }

        // Factor rating helpers
        function getRatingForTemp(temp, activity) {
            if (activity === "running") {
                if (temp < 5 || temp > 30) return "Unfavorable";
                if (temp < 10 || temp > 25) return "Moderate";
                return "Favorable";
            } else if (activity === "cycling") {
                if (temp < 0 || temp > 35) return "Unfavorable";
                if (temp < 5 || temp > 30) return "Moderate";
                return "Favorable";
            } else if (activity === "swimming") {
                if (temp < 20) return "Unfavorable";
                if (temp < 25) return "Moderate";
                return "Favorable";
            }

            // Default
            if (temp < 5 || temp > 30) return "Unfavorable";
            if (temp < 10 || temp > 25) return "Moderate";
            return "Favorable";
        }

        function getRatingForHumidity(humidity) {
            if (humidity > 85) return "Unfavorable";
            if (humidity > 70) return "Moderate";
            return "Favorable";
        }

        function getRatingForWind(wind, activity) {
            if (activity === "cycling") {
                if (wind > 25) return "Unfavorable";
                if (wind > 15) return "Moderate";
                return "Favorable";
            }

            // Default
            if (wind > 20) return "Unfavorable";
            if (wind > 10) return "Moderate";
            return "Favorable";
        }

        function getRatingForUV(uvi) {
            if (uvi > 7) return "Unfavorable";
            if (uvi > 5) return "Moderate";
            return "Favorable";
        }

        function getRatingForPrecipitation(weather) {
            if (['Thunderstorm', 'Snow'].includes(weather)) return "Unfavorable";
            if (['Rain', 'Drizzle'].includes(weather)) return "Moderate";
            return "Favorable";
        }

        function getRatingForRoadConditions(weather) {
            if (['Thunderstorm', 'Snow'].includes(weather)) return "Unfavorable";
            if (['Rain', 'Drizzle'].includes(weather)) return "Moderate";
            return "Favorable";
        }

        // Value getters
        function getPrecipitationValue(weather) {
            if (weather === 'Rain') return "Light";
            if (weather === 'Drizzle') return "Very Light";
            if (weather === 'Thunderstorm') return "Heavy";
            if (weather === 'Snow') return "Snow";
            return "None";
        }

        function getRoadConditions(weather) {
            if (weather === 'Rain' || weather === 'Drizzle') return "Wet";
            if (weather === 'Thunderstorm') return "Very Wet";
            if (weather === 'Snow') return "Snow Covered";
            if (weather === 'Mist') return "Damp";
            return "Dry";
        }

        function getWorkingHours(weather, temp) {
            if (['Rain', 'Thunderstorm', 'Snow'].includes(weather) || temp < 0 || temp > 35) return "Reduced";
            if (['Drizzle', 'Mist'].includes(weather) || temp < 5 || temp > 30) return "Normal";
            return "Extended";
        }

        function getMachineryOperation(weather, wind) {
            if (['Rain', 'Thunderstorm', 'Snow'].includes(weather) || wind > 25) return "Difficult";
            if (['Drizzle', 'Mist'].includes(weather) || wind > 15) return "Cautious";
            return "Optimal";
        }

        function getWindDescription(wind) {
            if (wind > 30) return "Strong";
            if (wind > 20) return "Moderate";
            if (wind > 10) return "Light";
            return "Calm";
        }

        // Description generators
        function getDescriptionForRunning(temp, weather, humidity, wind) {
            if (temp < 0 || temp > 30 || humidity > 85 || ['Rain', 'Thunderstorm', 'Snow'].includes(weather)) {
                return "Current conditions are challenging for running. Consider indoor alternatives or adjusting your routine based on specific factors.";
            } else if ((temp < 10 || temp > 25) || (humidity > 70) || wind > 15 || weather === 'Drizzle') {
                return "Running is possible but you may need to modify your routine. Pay attention to the specific factors that could impact your comfort and performance.";
            } else {
                return "Excellent conditions for running with comfortable temperatures and good overall weather. Enjoy your run while maintaining normal precautions.";
            }
        }

        function getDescriptionForCycling(temp, weather, wind, visibility) {
            if (temp < -5 || temp > 35 || wind > 25 || visibility < 5 || ['Thunderstorm', 'Snow'].includes(weather)) {
                return "Current conditions present significant challenges for cycling. Consider postponing or choosing indoor cycling options instead.";
            } else if ((temp < 5 || temp > 30) || wind > 15 || weather === 'Rain') {
                return "Cycling is possible but you'll face some challenges that require appropriate gear and adjustments to your ride plans.";
            } else {
                return "Good conditions for cycling with manageable weather factors. With proper preparation, you should have an enjoyable ride.";
            }
        }

        // Recommendation generators
        function getRecommendationsForRunning(temp, weather, humidity, wind, uvi) {
            const recommendations = [];

            if (temp < 10) {
                recommendations.push("Wear layered clothing to stay warm.");
                recommendations.push("Consider thermal running gear for extremities.");
            } else if (temp > 25) {
                recommendations.push("Stay hydrated and drink water before, during, and after your run.");
                recommendations.push("Run during cooler parts of the day (early morning or evening).");
            }

            if (humidity > 70) {
                recommendations.push("Reduce intensity due to higher humidity affecting cooling.");
                recommendations.push("Watch for signs of heat stress or exhaustion.");
            }

            if (wind > 15) {
                recommendations.push("Run with the wind at your back on the return portion of your route.");
                recommendations.push("Wear wind-resistant outer layer.");
            }

            if (uvi > 5) {
                recommendations.push("Apply sunscreen and wear a cap/visor.");
                recommendations.push("Wear UV-protective sunglasses.");
            }

            if (['Rain', 'Drizzle'].includes(weather)) {
                recommendations.push("Wear water-resistant gear and cap with brim.");
                recommendations.push("Choose shoes with good traction and visibility clothing.");
            }

            // If no specific recommendations, add generic ones
            if (recommendations.length < 2) {
                recommendations.push("Maintain good running form and breathing rhythm.");
                recommendations.push("Stay visible to traffic if running on roads.");
            }

            return recommendations.slice(0, 4); // Return at most 4 recommendations
        }

        function getRecommendationsForCycling(temp, weather, wind, uvi) {
            const recommendations = [];

            if (temp < 10) {
                recommendations.push("Wear windproof and thermal clothing layers.");
                recommendations.push("Cover extremities with gloves and head covering.");
            } else if (temp > 25) {
                recommendations.push("Stay hydrated and carry extra water.");
                recommendations.push("Apply sunscreen and reapply as needed.");
            }

            if (wind > 15) {
                recommendations.push("Be cautious of crosswinds, especially on bridges or exposed areas.");
                recommendations.push("Plan route to minimize headwind on return journey if possible.");
            }

            if (uvi > 5) {
                recommendations.push("Wear sunscreen, UV-protective eyewear, and lip protection.");
                recommendations.push("Take breaks in shaded areas.");
            }

            if (['Rain', 'Drizzle'].includes(weather)) {
                recommendations.push("Use lights and high-visibility clothing.");
                recommendations.push("Brake earlier as stopping distances increase on wet surfaces.");
                recommendations.push("Avoid painted lines and metal surfaces which become slippery.");
            }

            // If no specific recommendations, add generic ones
            if (recommendations.length < 2) {
                recommendations.push("Maintain proper hydration throughout your ride.");
                recommendations.push("Ensure your bike is in good working condition before starting.");
            }

            return recommendations.slice(0, 4); // Return at most 4 recommendations
        }

        // Initialize with server-side data if available
        {{if .currentWeather}}
        // If the server provided weather data, use it
        const serverData = {
            location: "{{.city}}",
            current: {
                temp: {{.currentWeather.Main.Temp}},
        weather: {
            main: "{{if .currentWeather.Weather}}{{(index .currentWeather.Weather 0).Main}}{{end}}",
                description: "{{if .currentWeather.Weather}}{{(index .currentWeather.Weather 0).Description}}{{end}}",
                icon: "{{if .currentWeather.Weather}}{{(index .currentWeather.Weather 0).Icon}}{{end}}"
        },
        humidity: {{.currentWeather.Main.Humidity}},
        wind_speed: {{.currentWeather.Wind.Speed}},
        visibility: {{.currentWeather.Visibility}},
        uvi: 5 // Default UV index as it might not be in the API response
    }
    };

        // Update UI with server data
        currentWeather = serverData;
        updateWeatherDisplay(serverData);
        generateImpactAssessments(serverData);

        // Hide loading indicator and show content
        loadingIndicator.classList.remove('active');
        currentWeatherSummary.style.display = 'flex';
        impactFilter.style.display = 'block';
        impactCards.style.display = 'grid';
        {{end}}
    });
</script>
<script src="../static/js/weather-impact-integration.js"></script>
<script src="../static/js/weather-impact.js"></script>

</body>
</html>